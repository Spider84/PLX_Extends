/*	0.0 215
0.16 201
0.32 160
0.48 134
0.64 120
0.80 109
0.96 101
1.12 94
1.28 88
1.44 82
1.60 78
1.76 73
1.92 69
2.08 65
2.24 61
2.40 57
2.56 53
2.72 50
2.88 46
3.04 42
3.20 38
3.36 34
3.52 30
3.68 26
3.84 21
4.00 17
4.16 11
4.32 5
4.48 -2
4.64 -13
4.80 -32
4.96 -40            */

#include "stm8l15x.h"
#include "fluidtemp.h"
#include <stdio.h>

int16_t trunc(int16_t temp);
int16_t lerp(int16_t adc1, int16_t adc2, int16_t adc, int16_t temp1, int16_t temp2);

const int16_t conv_table[32][2] = {
   {0, 2150},
 {134, 2010},
 {267, 1600},
 {401, 1340},
 {534, 1200},
 {668, 1090},
 {802, 1010},
 {935, 940},
{1069, 880},
{1202, 820},
{1336, 780},
{1469, 730},
{1603, 690},
{1737, 650},
{1870, 610},
{2004, 570},
{2137, 530},
{2271, 500},
{2405, 460},
{2538, 420},
{2672, 380},
{2805, 340},
{2939, 300},
{3073, 260},
{3206, 210},
{3340, 170},
{3473, 110},
{3607, 50},
{3740, -20},
{3874, -130},
{4008, -320},
{4141, -400}
};

const uint16_t speed_table[296][2] = {	
{54322, 20},  //5km/h
{45825, 24},
{39686, 28},
{35038, 32},
{31391, 36},
{28452, 40},
{26031, 44},
{24002, 48},
{22275, 52},
{20786, 56},
{19491, 60},
{18352, 64},
{17342, 68},
{16442, 72},
{15633, 76},
{14902, 80},
{14239, 84},
{13634, 88},
{13081, 92},
{12571, 96},
{12102, 100},
{11667, 104},
{11263, 108},
{10887, 112},
{10537, 116},
{10209, 120},
{9901, 124},
{9612, 128},
{9340, 132},
{9083, 135},
{8841, 139},
{8612, 143},
{8394, 147},
{8188, 151},
{7992, 155},
{7805, 159},
{7628, 163},
{7458, 167},
{7296, 171},
{7141, 175},
{6993, 179},
{6851, 183},
{6715, 187},
{6584, 191},
{6459, 195},
{6338, 199},
{6222, 203},
{6111, 207},
{6003, 211},
{5899, 215},
{5799, 219},
{5702, 223},
{5609, 227},
{5519, 231},
{5431, 235},
{5347, 239},
{5265, 243},
{5186, 247},
{5109, 251},
{5034, 255},
{4962, 259},
{4892, 263},
{4824, 266},
{4758, 270},
{4693, 274},
{4631, 278},
{4570, 282},
{4511, 286},
{4453, 290},
{4397, 294},
{4342, 298},
{4289, 302},
{4237, 306},
{4186, 310},
{4136, 314},
{4088, 318},
{4041, 322},
{3995, 326},
{3950, 330},
{3906, 334},
{3863, 338},
{3821, 342},
{3780, 346},
{3740, 350},
{3701, 354},
{3663, 358},
{3625, 362},
{3588, 366},
{3552, 370},
{3517, 374},
{3483, 378},
{3449, 382},
{3416, 386},
{3383, 390},
{3351, 394},
{3320, 397},
{3289, 401},
{3259, 405},
{3230, 409},
{3201, 413},
{3172, 417},
{3144, 421},
{3117, 425},
{3090, 429},
{3063, 433},
{3037, 437},
{3012, 441},
{2987, 445},
{2962, 449},
{2938, 453},
{2914, 457},
{2891, 461},
{2867, 465},
{2845, 469},
{2822, 473},
{2801, 477},
{2779, 481},
{2758, 485},
{2737, 489},
{2716, 493},
{2696, 497},
{2676, 501},
{2656, 505},
{2637, 509},
{2618, 513},
{2599, 517},
{2581, 521},
{2562, 525},
{2544, 529},
{2527, 532},
{2509, 536},
{2492, 540},
{2475, 544},
{2458, 548},
{2442, 552},
{2425, 556},
{2409, 560},
{2393, 564},
{2378, 568},
{2362, 572},
{2347, 576},
{2332, 580},
{2317, 584},
{2303, 588},
{2288, 592},
{2274, 596},
{2260, 600},
{2246, 604},
{2233, 608},
{2219, 612},
{2206, 616},
{2192, 620},
{2179, 624},
{2167, 628},
{2154, 632},
{2141, 636},
{2129, 640},
{2117, 644},
{2104, 648},
{2093, 652},
{2081, 656},
{2069, 660},
{2057, 663},
{2046, 667},
{2035, 671},
{2024, 675},
{2012, 679},
{2002, 683},
{1991, 687},
{1980, 691},
{1970, 695},
{1959, 699},
{1949, 703},
{1939, 707},
{1928, 711},
{1918, 715},
{1909, 719},
{1899, 723},
{1889, 727},
{1880, 731},
{1870, 735},
{1861, 739},
{1851, 743},
{1842, 747},
{1833, 751},
{1824, 755},
{1815, 759},
{1806, 763},
{1798, 767},
{1789, 771},
{1780, 775},
{1772, 779},
{1764, 783},
{1755, 787},
{1747, 791},
{1739, 794},
{1731, 798},
{1723, 802},
{1715, 806},
{1707, 810},
{1699, 814},
{1692, 818},
{1684, 822},
{1676, 826},
{1669, 830},
{1661, 834},
{1654, 838},
{1647, 842},
{1640, 846},
{1632, 850},
{1625, 854},
{1618, 858},
{1611, 862},
{1604, 866},
{1598, 870},
{1591, 874},
{1584, 878},
{1578, 882},
{1571, 886},
{1564, 890},
{1558, 894},
{1551, 898},
{1545, 902},
{1539, 906},
{1532, 910},
{1526, 914},
{1520, 918},
{1514, 922},
{1508, 926},
{1502, 929},
{1496, 933},
{1490, 937},
{1484, 941},
{1478, 945},
{1473, 949},
{1467, 953},
{1461, 957},
{1456, 961},
{1450, 965},
{1444, 969},
{1439, 973},
{1433, 977},
{1428, 981},
{1423, 985},
{1417, 989},
{1412, 993},
{1407, 997},
{1402, 1001},
{1396, 1005},
{1391, 1009},
{1386, 1013},
{1381, 1017},
{1376, 1021},
{1371, 1025},
{1366, 1029},
{1361, 1033},
{1356, 1037},
{1352, 1041},
{1347, 1045},
{1342, 1049},
{1337, 1053},
{1333, 1057},
{1328, 1060},
{1323, 1064},
{1319, 1068},
{1314, 1072},
{1310, 1076},
{1305, 1080},
{1301, 1084},
{1296, 1088},
{1292, 1092},
{1288, 1096},
{1283, 1100},
{1279, 1104},
{1275, 1108},
{1270, 1112},
{1266, 1116},
{1262, 1120},
{1258, 1124},
{1254, 1128},
{1250, 1132},
{1245, 1136},
{1241, 1140},
{1237, 1144},
{1233, 1148},
{1229, 1152},
{1225, 1156},
{1222, 1160},
{1218, 1164},
{1214, 1168},
{1210, 1172},
{1206, 1176},
{1202, 1180},
{1199, 1184},
{1195, 1188},
{1191, 1191}}; //300 km/h

const uint16_t oil_temp[5][4] = {
{70, 2015, 1826, 1542},
{90, 1327, 1222, 1037},
{110, 1004, 896, 756},
{130, 662, 603, 489},
{150, 365, 335, 254}};

int16_t lerp(int16_t adc1, int16_t adc2, int16_t adc, int16_t temp1, int16_t temp2) 
{
  return temp1 + ((int32_t)(temp2-temp1)*(adc-adc1))/(adc2-adc1);
}

int16_t trunc(int16_t temp)
{
  if (temp%10>=5) return (temp/10)+1;
  else return (temp/10);
}

int16_t getTemp(uint16_t adc) {
	for (uint8_t i=0;i<31;i++) {
	  if ((adc<=conv_table[i][0]) && (adc<conv_table[i+1][0])) {
		return trunc(lerp(conv_table[i][0],conv_table[i+1][0],adc,conv_table[i][1],conv_table[i+1][1]))-10;
	  }
	}
	return trunc(conv_table[31][1])-10;
}

uint16_t getOilTemp(uint16_t adc, uint8_t in_volt) {
	for (uint8_t i=0;i<4;i++) {
	  if ((adc>=oil_temp[i][2]) && (adc>oil_temp[i+1][2])) {
		return trunc(lerp(oil_temp[i][2],oil_temp[i+1][2],adc,oil_temp[i][0]*10,oil_temp[i+1][0]*10));
	  }
	}
	return trunc(oil_temp[4][0]*10);
  //return (uint16_t)((uint32_t)(1256UL*(uint32_t)adc)/40960U);
}

uint8_t calcThrtlPos(uint16_t adc)
{
  	if (adc<350U) return 0;
	return trunc(lerp(350U,3090U,adc,0,1000U));
}

/* 1atm = 2.2V
	   -470 = 1.4V  - не верно, но так было до того как я откалибровал
*/

uint16_t getBoost(uint16_t adc) // raw/329.47 = kg/sm^2
{   
    //До калибровки
    //int32_t boost = lerp(1808,1169,adc,0,-29)+100;
    int32_t boost = lerp(4096,647,adc,225,0);
  	return (uint16_t)((boost*32947UL)/10000UL);
}

uint16_t getSpeed(uint16_t timer)
{
  	if (timer==0xFFFF) return 0;
  	if (timer>speed_table[0][0]) return 16;
	for (uint16_t i=0;i<295;i++) {
	  if ((timer>=speed_table[i][0]) && (timer>speed_table[i+1][0])) {
		return speed_table[i][1];
	  }
	}
	return speed_table[295][1];
}

uint16_t getVoltValue(uint16_t adc)  //raw/51.15 Volts      14.5 -> 2.55  = 5.686   MAX = 18.765
{
  return (uint16_t)((uint32_t)(964614UL*(uint32_t)adc)/4096000U);
}

uint16_t getMAFValue(uint16_t adc)
{
  return (uint16_t)((uint32_t)(500L*(uint32_t)adc)/4096U);
}                                                                                   